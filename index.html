<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Blockchain Explorer</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- Styles -->
    <style>
        body {
            padding-top: 20px;
        }

        h1 {
            margin: 20px 0px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">
                <img src="img/picture.png" width="100" height="100">
                <h1 class="text-">Blockchain Explorer</h1>
                <p class="text-left"><span>Network ID: </span><span class="networkId"></span></p>
                <p class="text-left"><span>Peers: </span><span class="peerCount"></span></p>
                <p class="text-left stats"></p>
                <h3> Latest 20 blocks </h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">TxHash</th>
                            <th scope="col">Block</th>
                            <th scope="col">Timestamp</th>
                            <th scope="col">Gas Used</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <!-- Web3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.3.4/web3.min.js"></script>

    <script>
        const provider = 'https://mainnet.infura.io/v3/95ddb76135024471a15efebe034aa17f'; //Your Infura Endpoint
        // const provider = 'http://127.0.0.1:8110'; //Your private blockchain
        let web3Provider = new Web3.providers.HttpProvider(provider);
        let web3 = new Web3(web3Provider);
        web3.eth.net.getPeerCount().then((peerCount) => {
            $('.peerCount').text(`${peerCount + 1}`)
        });
        web3.eth.net.getId().then((networkId) => {
            $('.networkId').text(`${networkId}`)
        });

        const getEthStats = async () => {
            const gasPrice = await web3.eth.getGasPrice(); //average gas price
            const currentBlock = await web3.eth.getBlock("latest");
            let result = null;
            if (currentBlock.number !== null) { //only when block is mined not pending
                const previousBlock = await web3.eth.getBlock(currentBlock.parentHash);
                if (previousBlock.number !== null) {
                    const timeTaken = currentBlock.timestamp - previousBlock.timestamp;
                    const transactionCount = currentBlock.transactions.length;
                    const tps = transactionCount / timeTaken;
                    result = { currentBlockNumber: currentBlock.number, transactionCount, timeTaken, tps, gasPrice }
                }
            }
            return result;
        }

        const printStats = async () => {
            const stats = await getEthStats()
            if (stats !== null) {
                const { currentBlockNumber, transactionCount, timeTaken, tps, gasPrice } = stats;
                $('.stats').text(`Current Block (#${currentBlockNumber}): ${transactionCount} in ${timeTaken} seconds at the rate of ${tps} transactions/seconds. The average gas price is ${gasPrice} wei.`)
            }
        }
        printStats();
        web3.eth.getBlockNumber()
        .then((latestBlock) => {
            console.log(latestBlock);
            for (let i = 0; i < 20; i++) {
                web3.eth.getBlock(latestBlock - i)
                .then((block) => {
                    const number = block.number;
                    const hash = block.hash;
                    const block_time = block.timestamp;
                    const gas = block.gasUsed;
                    console.log(convertTimestamp(block_time));
                    $('tbody').append("<tr><td>" + hash + "</td><td>" + number + "</td><td>" + time1 + "</td><td>" + gas + "</tr>");
                });
            }
        });

        function convertTimestamp(block_time) {
            let d = new Date(block_time * 1000), // Convert the passed timestamp to milliseconds
                yyyy = d.getFullYear(),
                mm = ('0' + (d.getMonth() + 1)).slice(-2),  // Months are zero based. Add leading 0.
                dd = ('0' + d.getDate()).slice(-2),         // Add leading 0.
                hh = d.getHours(),
                h = hh,
                min = ('0' + d.getMinutes()).slice(-2),     // Add leading 0.
                ampm = 'AM',
                time;
            if (hh > 12) {
                h = hh - 12;
                ampm = 'PM';
            } else if (hh === 12) {
                h = 12;
                ampm = 'PM';
            } else if (hh == 0) {
                h = 12;
            }

            // ie: 2014-03-24, 3:00 PM
            time1 = yyyy + '-' + mm + '-' + dd + ', ' + h + ':' + min + ' ' + ampm;
            return time1;
        }
    </script>

</body>

</html>